<script>
let pc;
let dc;
let localStream;
let audioEl;

function setStatus(t) {
  document.getElementById("status").textContent = "Status: " + t;
}

async function startCall() {
  try {
    setStatus("Requesting mic...");
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

    setStatus("Getting token...");
    const tokenResp = await fetch("/token", { method: "POST" });
    const { token } = await tokenResp.json();

    if (!token) {
      setStatus("Token error");
      return;
    }

    pc = new RTCPeerConnection();

    audioEl = document.createElement("audio");
    audioEl.autoplay = true;
    audioEl.controls = true;
    document.body.appendChild(audioEl);

    pc.ontrack = (event) => {
      console.log("TRACK RECEIVED");
      audioEl.srcObject = event.streams[0];
    };

    localStream.getTracks().forEach(track =>
      pc.addTrack(track, localStream)
    );

    dc = pc.createDataChannel("oai-events");

    dc.onopen = () => {
      console.log("Data channel open");
    };

    dc.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      console.log("SERVER FULL MESSAGE:", msg);

      if (msg.type === "error") {
        console.error("SERVER ERROR:", msg);
      }

      if (msg.type === "session.created") {

        const scenario = document.getElementById("leadType").value;

        let instructions = "Say hello clearly.";

        if (scenario === "fsbo")
          instructions = "You are a skeptical homeowner selling FSBO. Start the call.";

        if (scenario === "expired")
          instructions = "You are frustrated your listing expired. Start the call.";

        if (scenario === "canceled")
          instructions = "You canceled your listing and distrust agents. Start the call.";

        if (scenario === "withdrawn")
          instructions = "You withdrew your home and are uncertain. Start the call.";

        if (scenario === "surprise")
          instructions = "You are a difficult random seller personality. Start the call.";

        // Minimal clean session config
        dc.send(JSON.stringify({
          type: "session.update",
          session: {
            voice: "alloy",
            turn_detection: { type: "server_vad" }
          }
        }));

        setTimeout(() => {
          dc.send(JSON.stringify({
            type: "response.create",
            response: {
              modalities: ["audio"],
              instructions: instructions
            }
          }));
        }, 500);

        setStatus("Speaking...");
      }
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const sdpResp = await fetch(
      "https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-12-17",
      {
        method: "POST",
        headers: {
          Authorization: "Bearer " + token,
          "Content-Type": "application/sdp"
        },
        body: offer.sdp
      }
    );

    const answer = await sdpResp.text();
    await pc.setRemoteDescription({ type: "answer", sdp: answer });

    document.getElementById("startBtn").disabled = true;
    document.getElementById("endBtn").disabled = false;

    setStatus("Connected");

  } catch (err) {
    console.error(err);
    setStatus("Error");
  }
}

function endCall() {
  if (dc) dc.close();
  if (pc) pc.close();
  if (localStream) localStream.getTracks().forEach(t => t.stop());
  if (audioEl) audioEl.remove();

  document.getElementById("startBtn").disabled = false;
  document.getElementById("endBtn").disabled = true;

  setStatus("Idle");
}

document.getElementById("startBtn").onclick = startCall;
document.getElementById("endBtn").onclick = endCall;
</script>
