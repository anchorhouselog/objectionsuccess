<script>
const WORKER_URL = "/token";

let pc = null;
let dc = null;
let localStream = null;
let audioEl = null;

function setStatus(t) {
  const status = document.getElementById("status");
  if (status) status.textContent = "Status: " + t;
}

async function startCall() {
  try {
    setStatus("Requesting microphoneâ€¦");

    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

    setStatus("Getting tokenâ€¦");

    const leadType = document.getElementById("leadType").value;

    const tokenResp = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ leadType })
    });

    const tokenJson = await tokenResp.json();

    if (!tokenResp.ok || !tokenJson.token) {
      console.error("Token error:", tokenJson);
      setStatus("Token error (backend issue).");
      return;
    }

    const EPHEMERAL_TOKEN = tokenJson.token;

    pc = new RTCPeerConnection();

    // Create audio element safely
    audioEl = document.createElement("audio");
    audioEl.autoplay = true;
    audioEl.playsInline = true;
    audioEl.muted = false;
    audioEl.volume = 1;
    document.body.appendChild(audioEl);

    pc.ontrack = async (event) => {
      audioEl.srcObject = event.streams[0];

      try {
        await audioEl.play();
        console.log("Audio playback started");
      } catch (err) {
        console.error("Playback blocked:", err);
      }
    };

    // Add mic track
    localStream.getTracks().forEach(track =>
      pc.addTrack(track, localStream)
    );

    // Data channel
    dc = pc.createDataChannel("oai-events");

    dc.onopen = () => {
      setStatus("Connected.");

      // Enable server VAD
      dc.send(JSON.stringify({
        type: "session.update",
        session: {
          turn_detection: { type: "server_vad" }
        }
      }));

      // Force AI to speak first
      dc.send(JSON.stringify({
        type: "response.create",
        response: {
          modalities: ["audio", "text"],
          instructions: "Start the conversation by saying hello and introducing yourself."
        }
      }));
    };

    dc.onmessage = (event) => {
      const msg = JSON.parse(event.data);

      if (msg.type === "response.output_text.delta") {
        console.log("AI text:", msg.delta);
      }

      if (msg.type === "response.completed") {
        console.log("AI finished speaking");
      }
    };

    setStatus("Connectingâ€¦");

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const sdpResp = await fetch(
      "https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview",
      {
        method: "POST",
        headers: {
          Authorization: "Bearer " + EPHEMERAL_TOKEN,
          "Content-Type": "application/sdp"
        },
        body: offer.sdp
      }
    );

    const answerSdp = await sdpResp.text();

    await pc.setRemoteDescription({
      type: "answer",
      sdp: answerSdp
    });

    document.getElementById("startBtn").disabled = true;
    document.getElementById("endBtn").disabled = false;

  } catch (err) {
    console.error("Start call error:", err);
    setStatus("Mic blocked or connection failed.");
  }
}

async function endCall() {
  setStatus("Endingâ€¦");

  try {
    if (dc && dc.readyState === "open") dc.close();
    if (pc) pc.close();
    if (localStream)
      localStream.getTracks().forEach(t => t.stop());
    if (audioEl) audioEl.remove();
  } catch (e) {}

  pc = null;
  dc = null;
  localStream = null;
  audioEl = null;

  document.getElementById("startBtn").disabled = false;
  document.getElementById("endBtn").disabled = true;

  setStatus("idle");
}

// ðŸ”¥ Prevent blank page crash
window.addEventListener("DOMContentLoaded", () => {
  const startBtn = document.getElementById("startBtn");
  const endBtn = document.getElementById("endBtn");

  if (startBtn) startBtn.addEventListener("click", startCall);
  if (endBtn) endBtn.addEventListener("click", endCall);
});
</script>
