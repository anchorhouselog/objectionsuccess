<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ObjectionSuccess</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body style="font-family: system-ui; padding: 30px; max-width: 720px; margin:auto;">

<h2>ObjectionSuccess (Private Beta)</h2>

<button id="startBtn">ðŸ“ž Start Call</button>
<button id="endBtn" disabled>â›” End Call</button>

<p id="status">Status: idle</p>

<script>
let pc;
let dc;
let localStream;
let audioEl;

function setStatus(t) {
  document.getElementById("status").textContent = "Status: " + t;
}

async function startCall() {
  try {

    setStatus("Requesting microphone...");
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

    setStatus("Getting session token...");

    const tokenResp = await fetch("/token", {
      method: "POST"
    });

    if (!tokenResp.ok) {
      const errText = await tokenResp.text();
      console.error("Token error:", errText);
      setStatus("Token error");
      return;
    }

    const tokenJson = await tokenResp.json();
    const EPHEMERAL_TOKEN = tokenJson.token;

    if (!EPHEMERAL_TOKEN) {
      console.error("No token returned:", tokenJson);
      setStatus("Invalid token");
      return;
    }

    pc = new RTCPeerConnection();

    audioEl = document.createElement("audio");
    audioEl.autoplay = true;
    audioEl.playsInline = true;
    document.body.appendChild(audioEl);

    pc.ontrack = (event) => {
      console.log("Audio track received");
      audioEl.srcObject = event.streams[0];
    };

    pc.onconnectionstatechange = () => {
      console.log("Connection state:", pc.connectionState);
    };

    localStream.getTracks().forEach(track =>
      pc.addTrack(track, localStream)
    );

    dc = pc.createDataChannel("oai-events");

    dc.onopen = () => {
      console.log("Data channel open");

      dc.send(JSON.stringify({
        type: "session.update",
        session: {
          modalities: ["audio"],
          voice: "alloy",
          turn_detection: { type: "server_vad" }
        }
      }));

      dc.send(JSON.stringify({
        type: "response.create",
        response: {
          modalities: ["audio"],
          instructions: "Say hello."
        }
      }));

      setStatus("Connected");
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const sdpResp = await fetch(
      "https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-12-17",
      {
        method: "POST",
        headers: {
          Authorization: "Bearer " + EPHEMERAL_TOKEN,
          "Content-Type": "application/sdp"
        },
        body: offer.sdp
      }
    );

    if (!sdpResp.ok) {
      const errText = await sdpResp.text();
      console.error("SDP negotiation failed:", errText);
      setStatus("SDP error");
      return;
    }

    const answer = await sdpResp.text();

    await pc.setRemoteDescription({
      type: "answer",
      sdp: answer
    });

    document.getElementById("startBtn").disabled = true;
    document.getElementById("endBtn").disabled = false;

  } catch (err) {
    console.error("Start call error:", err);
    setStatus("Error starting call");
  }
}

function endCall() {
  if (dc) dc.close();
  if (pc) pc.close();
  if (localStream) localStream.getTracks().forEach(t => t.stop());
  if (audioEl) audioEl.remove();

  document.getElementById("startBtn").disabled = false;
  document.getElementById("endBtn").disabled = true;

  setStatus("Idle");
}

document.getElementById("startBtn").onclick = startCall;
document.getElementById("endBtn").onclick = endCall;
</script>

</body>
</html>
