<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ObjectionSuccess</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body style="font-family: system-ui; padding: 30px; max-width: 720px; margin:auto;">
  <h2>ObjectionSuccess (Private Beta)</h2>

  <label>Scenario:</label>
  <select id="leadType">
    <option value="surprise">Surprise me</option>
    <option value="fsbo">FSBO</option>
    <option value="expired">Expired</option>
    <option value="canceled">Canceled</option>
    <option value="withdrawn">Withdrawn</option>
  </select>

  <div style="margin-top:16px;">
    <button id="startBtn">ðŸ“ž Start Call</button>
    <button id="endBtn" disabled>â›” End Call</button>
  </div>

  <p id="status" style="margin-top: 14px;">Status: idle</p>

<script>
const WORKER_URL = "https://objectionsuccess.alex-b70.workers.dev";
let pc, dc, localStream, audioEl;

function setStatus(t){ document.getElementById("status").textContent = "Status: " + t; }

async function startCall() {
  try {
    setStatus("Requesting microphoneâ€¦");
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

    setStatus("Getting tokenâ€¦");
    const leadType = document.getElementById("leadType").value;

    const tokenResp = await fetch(WORKER_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ leadType })
    });

    const tokenJson = await tokenResp.json().catch(() => ({}));
    if (!tokenResp.ok || !tokenJson.token) {
      console.error("Token error:", tokenJson);
      setStatus("Token error (check Worker logs / API key).");
      return;
    }

    const EPHEMERAL_TOKEN = tokenJson.token;

    pc = new RTCPeerConnection();

    audioEl = document.createElement("audio");
    audioEl.autoplay = true;
    document.body.appendChild(audioEl);

    pc.ontrack = (event) => { audioEl.srcObject = event.streams[0]; };

    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    dc = pc.createDataChannel("oai-events");
    dc.onopen = () => setStatus("Connected. Speak now.");
    dc.onmessage = () => {}; // ignore text

    setStatus("Connectingâ€¦");
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const realtimeUrl = "https://api.openai.com/v1/realtime?model=gpt-realtime";
    const sdpResp = await fetch(realtimeUrl, {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + EPHEMERAL_TOKEN,
        "Content-Type": "application/sdp"
      },
      body: offer.sdp
    });

    const answerSdp = await sdpResp.text();
    await pc.setRemoteDescription({ type: "answer", sdp: answerSdp });

    document.getElementById("startBtn").disabled = true;
    document.getElementById("endBtn").disabled = false;

  } catch (e) {
    console.error(e);
    setStatus("Mic blocked. Use Chrome, allow mic, refresh.");
  }
}

async function endCall() {
  setStatus("Endingâ€¦");
  try {
    if (dc && dc.readyState === "open") dc.close();
    if (pc) pc.close();
    if (localStream) localStream.getTracks().forEach(t => t.stop());
    if (audioEl) audioEl.remove();
  } catch (e) {}

  pc = null; dc = null; localStream = null; audioEl = null;

  document.getElementById("startBtn").disabled = false;
  document.getElementById("endBtn").disabled = true;
  setStatus("idle");
}

document.getElementById("startBtn").addEventListener("click", startCall);
document.getElementById("endBtn").addEventListener("click", endCall);
</script>
</body>
</html>