<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ObjectionSuccess (PCM)</title>
</head>
<body style="font-family: system-ui; padding: 30px; max-width: 700px; margin:auto;">

<h2>ObjectionSuccess (Stable PCM Mode)</h2>

<select id="leadType">
  <option value="surprise">Surprise me</option>
  <option value="fsbo">FSBO</option>
  <option value="expired">Expired</option>
  <option value="canceled">Canceled</option>
  <option value="withdrawn">Withdrawn</option>
</select>

<br><br>

<button onclick="startCall()">Start Call</button>

<p id="status">Status: idle</p>

<script>

let pc;
let dc;
let audioCtx = null;
let nextPlayTime = 0;

function setStatus(text) {
  document.getElementById("status").innerText = "Status: " + text;
}

function base64ToFloat32(base64) {
  const binary = atob(base64);
  const len = binary.length;
  const buffer = new ArrayBuffer(len);
  const view = new Uint8Array(buffer);

  for (let i = 0; i < len; i++) {
    view[i] = binary.charCodeAt(i);
  }

  const pcm = new Int16Array(buffer);
  const float32 = new Float32Array(pcm.length);

  for (let i = 0; i < pcm.length; i++) {
    float32[i] = pcm[i] / 32768;
  }

  return float32;
}

function playPCM(float32) {
  if (!audioCtx) {
    audioCtx = new AudioContext({ sampleRate: 24000 });
  }

  const buffer = audioCtx.createBuffer(1, float32.length, 24000);
  buffer.copyToChannel(float32, 0);

  const source = audioCtx.createBufferSource();
  source.buffer = buffer;
  source.connect(audioCtx.destination);

  if (nextPlayTime < audioCtx.currentTime) {
    nextPlayTime = audioCtx.currentTime;
  }

  source.start(nextPlayTime);
  nextPlayTime += buffer.duration;
}

async function startCall() {
  try {

    setStatus("Getting token...");

    const tokenResp = await fetch("/token", { method: "POST" });
    const tokenData = await tokenResp.json();

    if (!tokenData.token) {
      console.error("Token error:", tokenData);
      setStatus("Token error");
      return;
    }

    pc = new RTCPeerConnection();

    // Required so offer contains audio section
    pc.addTransceiver("audio", { direction: "recvonly" });

    dc = pc.createDataChannel("oai-events");

    dc.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      console.log("SERVER:", msg);

      if (msg.type === "session.created") {

        // Enable audio system
        dc.send(JSON.stringify({
          type: "session.update",
          session: {
            modalities: ["audio", "text"],
            voice: "alloy"
          }
        }));

        const scenario = document.getElementById("leadType").value;

        let text = "Say hello clearly.";

        if (scenario === "fsbo") text = "You are a skeptical FSBO seller. Speak.";
        if (scenario === "expired") text = "You are frustrated your listing expired. Speak.";
        if (scenario === "canceled") text = "You distrust agents. Speak.";
        if (scenario === "withdrawn") text = "You are unsure what to do. Speak.";
        if (scenario === "surprise") text = "You are a difficult seller personality. Speak.";

        setTimeout(() => {
          dc.send(JSON.stringify({
            type: "response.create",
            response: {
              modalities: ["audio", "text"],
              instructions: text,
              audio: {
                voice: "alloy",
                format: "pcm16"
              }
            }
          }));
        }, 300);

        setStatus("Speaking...");
      }

      // ðŸ”¥ THIS IS WHAT WE WANT
      if (msg.type === "response.output_audio.delta") {
        const float32 = base64ToFloat32(msg.delta);
        playPCM(float32);
      }

      if (msg.type === "response.done") {
        setStatus("Done");
      }
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const sdpResp = await fetch(
      "https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-12-17",
      {
        method: "POST",
        headers: {
          Authorization: "Bearer " + tokenData.token,
          "Content-Type": "application/sdp"
        },
        body: offer.sdp
      }
    );

    if (!sdpResp.ok) {
      const errText = await sdpResp.text();
      console.error("Realtime error:", errText);
      setStatus("Realtime error");
      return;
    }

    const answer = await sdpResp.text();
    await pc.setRemoteDescription({ type: "answer", sdp: answer });

    setStatus("Connected");

  } catch (e) {
    console.error(e);
    setStatus("Error");
  }
}

</script>

</body>
</html>
